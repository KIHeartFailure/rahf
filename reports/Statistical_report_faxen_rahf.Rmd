---
title: 'Statistical report: Association Between Rheumatoid Arthritis and Ejection Fraction in Incident Heart Failure'
author: 'Statistician: Lina Benson'
  
date: "`r Sys.Date()`"
output:
  pdf_document:
    fig_caption: yes
    fig_height: 7
    fig_width: 7
    number_sections: yes
link-citations: yes
bibliography: references.bib
nocite: '@*'
---

\clearpage
\newpage 

\tableofcontents 
\listoftables
\listoffigures
\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE, include = TRUE, comment = "",
  warning = FALSE, message = FALSE, fig.pos = "H",
  fig.path = "../output/figs/"
)
options(knitr.kable.NA = "")
```

```{r adjust_directory_if_needed, include=FALSE}
# Uncomment lines below if rmd file is placed in a subdirectory
knitr::opts_knit$set(root.dir = normalizePath("../"))
```

```{r load_project}
# 1. Set options in config/global.dcf
# 2. Load packages listed in config/global.dcf
# 3. Import functions and code in lib directory

ProjectTemplate::reload.project()

cacheon <- TRUE
```             

# Data handling

## Data source

SHFDB3, https://kiheartfailure.github.io/shfdb3/, v 3.2.2. 

## Inclusion/exclusion criteria

```{r flow}
footnote(
  default_kable(flow, caption = "Flowchart"),
  symbol = "A period of 14 days is allowed between first registration in NPR and registration in SwedeHF."
)
```

First patient in: `r min(pdata$shf_indexdtm)` and last patient in: `r max(pdata$shf_indexdtm)`.  

The median age (IQR) is `r pdata %>% summarise(med = fn(median(shf_age), dig = 1),
                                             q1 = fn(quantile(shf_age, probs = 0.25), dig = 1),
                                             q3 = fn(quantile(shf_age, probs = 0.75), dig = 1)) %>%
                                   mutate(out = paste0(med, " (", q1, "-", q3, ")")) %>%
                                   pull(out)` and 
`r pdata %>% count(shf_sex) %>%
  mutate(perc = fn(n / sum(n) * 100, 1)) %>%
  filter(shf_sex == "Female") %>%
  pull(perc)`% females.    
  
## HF/EF

By excluding cases with previous diagnosis of HF in NPR/SwedeHF the aim is to keep only incident HF cases and thereby
aim to discuss directionality. 

EF is recorded in SwedeHF. The primary analysis will be on EF </=> 40% due to the small number of patients 
with previous RA. Analyses EF <30% (rEF), 40-49% (mrEF) and =>50% (pEF) will also be presented.  

## Definition of RA 

Two visits (spec öppenvård) with HDIA M05, M06, where at least on of the visits 
should be at an internal medicine/reumatological ward (MVO 101, 131). 
The onset of RA diagnosis is then defined to the second visit. If a visit with 
HDIA M073, L405, M45, M46, M32 occurs prior to the second visit this patient 
is not defined as a RA. 

## Variables created specifically for this project

```{r sos}
default_kable(metaout, caption = "Additional outcomes from NPR", scale_down = F)
```

\clearpage

# Statistical analysis 

## General

All analyses were performed using `r sessionInfo()$R.version$version.string` [@r]. 
The level of significance is set to 5%, two-sided. No adjustment for multiple 
comparisons were made and therefore the results should be viewed with some care.

### Subgroup analysis - In/out-patients

Subgroup analysis will be performed on patients recorded as out- or in-patients in SwedeHF. 

### Consistency analysis - Blankning

No blanking period (time prior to HF diagnosis were diagnosis of RA is not considered) 
is applied in the main analysis. As a consistency analysis a blanking period of 6 months is applied. 

## Baseline characteristics

```{r, child = "../src/tab1.Rmd"}

```

## Association between incident HF and prior RA

The association between incident HF and prior RA is investigated 
using logistic regression (EF 2 groups) and multinomial regression (EF 3 groups) 
where the outcome is EF group. 

Adjustment is performed for variables that are present at the 
time of the incident HF. 

Adjustment is partly performed for `r paste0(modvars1, collapse = ", ")` 

and partly `r paste0(modvars2, collapse = ", ")`.

### Assumptions

Outliers were investigated with Cook's distance and multicollinearity 
with the variance inflation factor. => No action deemed necessary. 

```{r, child = "../src/mortab.Rmd"}

```

\clearpage
\newpage

## Outcomes after HF

The patients with prior RA are compared to those without prior RA. 

The following outcomes are considered: 

- Cardiovascular mortality/first hospitalization for HF/stroke/MI (primary endpoint)
- First hospitalization for HF
- All-cause mortality

Incidence per 1000 py is calculated with 95% Poisson confidence intervals. 
The outcomes are presented with 1-KM curves. 
Cox proportional hazards regressions are used to evaluate the association 
between prior RA and the respective outcomes. The interaction between 
prior RA and EF is included in the model and adjustment performed on variables that are present at the 
time of the incident HF for the same variables as in the previous models. 
Data are censored at 2019-12-31, death (for outcomes not including all-cause mortality), emigration from Sweden 
(=lost to follow-up in the national Swedish registries) or 10 years after index, whichever came first. 

The median (min-max) follow-up is 
`r pdata %>% summarise(med = fn(median(sos_outtime_death / 365.25 * 12), dig = 1),
                                             min = fn(min(sos_outtime_death / 365.25 * 12), dig = 1),
                                             max = fn(max(sos_outtime_death / 365.25 * 12), dig = 1)) %>%
                                   mutate(out = paste0(med, " (", min, "-", max, ")")) %>%
                                   pull(out)` months for a total of 
                                   `r pdata %>% summarise(sumpy = fn(sum(sos_outtime_death) / 365.25, dig = 0)) %>%
                                   pull(sumpy)` patient-years of follow-up.


### Assumptions

The proportional hazards assumption was investigated using the scaled Schoenfeld 
residuals (cox.zph in [@survival-package]). Signs of non-proportional hazards were 
shown for EF group, driven mainly by the in-patient population were higher EF 
initially shows lower hazard but after approximately 2 years the difference 
between EF starts to decrease. See Figure \ref{fig:nonpropplot}. 

```{r, child = "../src/checkass.Rmd"}

```

\clearpage
\newpage

```{r, child = "../src/km.Rmd"}

```

```{r, child = "../src/coxtab.Rmd"}

```

\clearpage
\newpage

# Reproducibility

## R session information {#sessioninfo}

```{r sessinfo}
sessionInfo()
```

## R code

The R code for all data handling and statistical analyses are found: 
https://github.com/KIHeartFailure/rahf. On publication
the repository will be made public so as to 
link to it from the resulting article for increased transparency and code sharing.
No data or output is stored in the repository. 

# References
