```{r km, cache=cacheon}

kmfunc <- function(data, time, event, eventname, yposplus = rep(0, 4)) {
  fit <- survfit(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ shf_ef_cat2 + sos_com_ra")),
    data = data
  )

  ## logrank
  # sd <- survdiff(formula(paste0("Surv(", time, ",", event, "=='Yes') ~ shf_ef_cat + sos_com_ra")),
  #  data = data %>% filter(casecontrol == "Case")
  # )

  # p <- dF(pchisq(sd$chisq, length(sd$n) - 1, lower.tail = FALSE), dig = 3, p = TRUE)

  # c(bottom, left, top, right)
  par(mar = c(4, 6, 1, 8) + 0.1)
  plots <- plot(fit,
    fun = "event",
    ylab = eventname,
    xscale = 365,
    yscale = 100,
    col = rep(global_kicols[1:2], each = 2),
    mark.time = FALSE,
    bty = "n",
    xlim = c(0, 5 * 365),
    ylim = c(0, 1),
    xlab = "Years",
    axes = F,
    lwd = 1.5,
    lty = c(1, 2),
    xaxs = "i", yaxs = "i"
  )

  axis(2, seq(0, 1, 0.25), seq(0, 100, 25), las = 2)
  axis(1, at = seq(0, 5, 1) * 365, seq(0, 5, 1))

  ypos <- 1 - summary(fit, 5 * 365)$surv
  ytext <- paste0(rep(levels(pdata$shf_ef_cat2), each = 2), "/", rep(c("No RA", "RA"), 2))

  ylabs <- bind_cols(ypos = ypos + yposplus, ytext = ytext)

  mtext(
    side = 4,
    line = .2,
    at = ylabs$ypos,
    ylabs$ytext,
    las = 1
  )

  # text(2 * 365, 0.75, paste0("Log-rank p = ", p), pos = 4)
}
```

```{r kmcvdeathhfstrokemihospall, fig.cap="1-KM CVD/First HF/stroke/MI hospitalization - All", cache=cacheon, dependson="km"}
kmfunc(
  data = pdata,
  time = "sos_outtime_deathcvhosphfstrokemi", event = "sos_out_deathcvhosphfstrokemi",
  eventname = "CVD/First HF/stroke/MI hospitalization (%)",
  yposplus = c(0.01, 0, 0.0, -0.0)
)
```

```{r kmhfhospall, fig.cap="1-KM First HF hospitalization - All", cache=cacheon, dependson="km"}
kmfunc(
  data = pdata,
  time = "sos_outtime_hosphf", event = "sos_out_hosphf", 
  eventname = "First HF hospitalization (%)",
  yposplus = c(0.0, 0, -0.0, 0)
)
```

```{r kmdeathall, fig.cap="1-KM Death - All", cache=cacheon, dependson="km"}
kmfunc(
  data = pdata,
  time = "sos_outtime_death", event = "sos_out_death", eventname = "Death (%)",
  yposplus = c(0, -0.0, -0.0, 0.0)
)
```

```{r kmcvdeathhfstrokemihospout, fig.cap="1-KM CVD/First HF/stroke/MI hospitalization - Out-patients", cache=cacheon, dependson="km"}
kmfunc(
  data = pdata %>% filter(shf_location == "Out-patient"),
  time = "sos_outtime_deathcvhosphfstrokemi", event = "sos_out_deathcvhosphfstrokemi",
  eventname = "CVD/First HF/stroke/MI hospitalization (%)",
  yposplus = c(0, 0, 0, 0)
  # "<40%/No RA"  "<40%/RA"     "=>40%/No RA" "=>40%/RA"
)
```

```{r kmhfhospout, fig.cap="1-KM First HF hospitalization - Out-patients", cache=cacheon, dependson="km"}
kmfunc(
  data = pdata %>% filter(shf_location == "Out-patient"),
  time = "sos_outtime_hosphf", event = "sos_out_hosphf", 
  eventname = "First HF hospitalization (%)",
  yposplus = c(0, 0, 0, 0)
)
# "<40%/No RA"  "<40%/RA"     "=>40%/No RA" "=>40%/RA"
```

```{r kmdeathout, fig.cap="1-KM Death - Out-patients", cache=cacheon, dependson="km"}
kmfunc(
  data = pdata %>% filter(shf_location == "Out-patient"),
  time = "sos_outtime_death", event = "sos_out_death", eventname = "Death (%)",
  yposplus = c(0.01, 0, 0.01, -0.00)
)
# "<40%/No RA"  "<40%/RA"     "=>40%/No RA" "=>40%/RA"
```

```{r kmcvdeathhfstrokemihospin, fig.cap="1-KM CVD/First HF/stroke/MI hospitalization - In-patients", cache=cacheon, dependson="km"}
kmfunc(
  data = pdata %>% filter(shf_location == "In-patient"),
  time = "sos_outtime_deathcvhosphfstrokemi", event = "sos_out_deathcvhosphfstrokemi",
  eventname = "CVD/First HF/stroke/MI hospitalization (%)",
  yposplus = c(0.01, 0, 0.01, -0.005)
)
# "<40%/No RA"  "<40%/RA"     "=>40%/No RA" "=>40%/RA"
```

```{r kmhfhospin, fig.cap="1-KM First HF hospitalization - In-patients", cache=cacheon, dependson="km"}
kmfunc(
  data = pdata %>% filter(shf_location == "In-patient"),
  time = "sos_outtime_hosphf", event = "sos_out_hosphf", 
  eventname = "First HF hospitalization (%)",
  yposplus = c(0.02, 0, 0.005, -0.006)
)
```

```{r kmdeathin, fig.cap="1-KM Death - In-patients", cache=cacheon, dependson="km"}
kmfunc(
  data = pdata %>% filter(shf_location == "In-patient"),
  time = "sos_outtime_death", event = "sos_out_death", eventname = "Death (%)",
  yposplus = c(0, -0.0, -0, 0.0)
)
```