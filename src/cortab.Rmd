```{r cortab, cache=cacheon}

cortabfunc <- function(data, title, efvar, ravar) {
  levsef <- levels(pdata %>% pull(!!sym(efvar)))

  out <- data.frame(matrix(NA, ncol = length(levsef) + 1, nrow = 3))

  colnames(out) <- c(
    "Model",
    levsef
  )

  for (i in seq_along(levsef)) {

    ## crude
    mod <- summary(clogit(formula(paste0("casecontrol == 'Case' ~ ", ravar, " * 
    relevel(", efvar, ", ref = '", levsef[i], "') + strata(LopNrcase)")),
      data = data
    ))

    out[1, 1] <- "Crude OR (95% CI), p"
    out[1, (1 + i)] <- c(
      paste0(
        dF(mod$conf.int[1, 1], 1), " (", dF(mod$conf.int[1, 3], 1), "-",
        dF(mod$conf.int[1, 4], 1), "), ", dF(mod$coefficients[1, 5], dig = 3, p = T)
      )
    )

    ## adj comorbs
    mod <- summary(clogit(formula(paste0(
      "casecontrol == 'Case' ~", ravar, " * relevel(", efvar, ", ref = '",
      levsef[i], "') + ",
      paste(modvars1, collapse = " + "), " + strata(LopNrcase)"
    )),
    data = data
    ))

    out[2, 1] <- "Adj comorbs OR (95% CI), p"
    out[2, (1 + i)] <- c(
      paste0(
        dF(mod$conf.int[1, 1], 1), " (", dF(mod$conf.int[1, 3], 1), "-",
        dF(mod$conf.int[1, 4], 1), "), ", dF(mod$coefficients[1, 5], dig = 3, p = T)
      )
    )


    ## adj comorbs + socioec
    mod <- summary(clogit(formula(paste0(
      "casecontrol == 'Case' ~ ", ravar, " * relevel(", efvar, ", ref = '",
      levsef[i], "') + ",
      paste(modvars2, collapse = " + "), " + strata(LopNrcase)"
    )),
    data = data
    ))

    out[3, 1] <- "Adj comorbs, socec OR (95% CI), p"
    out[3, (1 + i)] <- c(
      paste0(
        dF(mod$conf.int[1, 1], 1), " (", dF(mod$conf.int[1, 3], 1), "-",
        dF(mod$conf.int[1, 4], 1), "), ", dF(mod$coefficients[1, 5], dig = 3, p = T)
      )
    )
  }

  footnote(mykable(out,
    caption = sanitize_text(paste0("Associations between incident HF compared to controls and prior RA ", title))
  ),
  symbol = c(
    "All analyses adjusted for age, sex and county of residence through matching"
  )
  )
}
```

```{r cortab2out, cache=cacheon, dependson="cortab"}
cortabfunc(
  data = pdata %>% filter(shf_location == "Out-patient"),
  title = "by EF </>=40% - Out-patients",
  efvar = "shf_ef_cat2",
  ravar = "sos_com_ra"
)
```

```{r cortab2blankout, cache=cacheon, dependson="cortab"}
cortabfunc(
  data = pdata %>% filter(shf_location == "Out-patient"),
  title = "with blanking 6 mo by EF </>=40% - Out-patients",
  efvar = "shf_ef_cat2",
  ravar = "sos_com_ra_blank6mo"
)
```

```{r cortab3out, cache=cacheon, dependson="cortab"}
cortabfunc(
  data = pdata %>% filter(shf_location == "Out-patient"),
  title = "by EF p, mr, r - Out-patients",
  efvar = "shf_ef_cat",
  ravar = "sos_com_ra"
)
```

```{r cortab2in, cache=cacheon, dependson="cortab"}
cortabfunc(
  data = pdata %>% filter(shf_location == "In-patient"),
  title = "by EF </>=40% - In-patients",
  efvar = "shf_ef_cat2",
  ravar = "sos_com_ra"
)
```

```{r cortab2blankin, cache=cacheon, dependson="cortab"}
cortabfunc(
  data = pdata %>% filter(shf_location == "In-patient"),
  title = "with blanking 6 mo by EF </>=40% - In-patients",
  efvar = "shf_ef_cat2",
  ravar = "sos_com_ra_blank6mo"
)
```

```{r cortab3in, cache=cacheon, dependson="cortab"}
cortabfunc(
  data = pdata %>% filter(shf_location == "In-patient"),
  title = "by EF p, mr, r - In-patients",
  efvar = "shf_ef_cat",
  ravar = "sos_com_ra"
)
```
